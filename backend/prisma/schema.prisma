generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  EMPLOYEE
  ADMIN
}

enum InquiryStatus {
  PENDING
  RESPONDED
}

enum CaseStatus {
  NEW
  IN_REVIEW
  WAITING_ON_CLIENT
  SCHEDULED
  ON_HOLD
  COMPLETED
}

enum AppointmentMode {
  CALL
  VIDEO
  IN_PERSON
}

enum AppointmentStatus {
  REQUESTED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  VOID
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum DocumentKind {
  CASE
  PROFILE
  OTHER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  role         Role     @default(USER)
  passwordHash String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile          ClientProfile?
  calculations     Calculation[]
  inquiries        Inquiry[]
  activities       Activity[]
  ownedDocuments   Document[]          @relation("OwnedDocuments")
  profileDocuments Document[]          @relation("ProfileDocuments")
  clientCases      TaxCase[]           @relation("ClientCases")
  assignedCases    TaxCase[]           @relation("AssignedCases")
  authoredNotes    CaseInternalNote[]  @relation("AuthoredNotes")
  assignedTasks    CaseTask[]          @relation("AssignedTasks")

  @@index([role, createdAt])
}

model ClientProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  phone            String    @default("")
  whatsapp         String    @default("")
  address          String    @default("")
  pan              String    @default("")
  aadhaar          String    @default("")
  aadhaarDocumentId String? @unique
  aadhaarDocument  Document? @relation("AadhaarDocument", fields: [aadhaarDocumentId], references: [id], onDelete: SetNull)

  notifyEmail      Boolean   @default(true)
  notifyWhatsapp   Boolean   @default(false)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
}

model Calculation {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            String
  label           String
  inputs          Json
  results         Json
  sourceTimestamp DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([type, createdAt])
}

model Inquiry {
  id        String        @id @default(cuid())
  userId    String?
  user      User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  name      String
  email     String
  service   String
  message   String
  status    InquiryStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email, createdAt])
  @@index([status, createdAt])
}

model Activity {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  userName  String
  userEmail String
  action    String
  details   String
  createdAt DateTime @default(now())

  @@index([userEmail, createdAt])
  @@index([action, createdAt])
}

model TaxCase {
  id           String     @id @default(cuid())

  clientId     String
  client       User       @relation("ClientCases", fields: [clientId], references: [id], onDelete: Cascade)

  assignedToUserId String?
  assignedTo   User?      @relation("AssignedCases", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  title        String
  service      String
  status       CaseStatus @default(NEW)

  providedData Json

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  documents    Document[]
  appointments CaseAppointment[]
  invoices     CaseInvoice[]
  tasks        CaseTask[]
  internalNotes CaseInternalNote[]

  @@index([clientId, updatedAt])
  @@index([assignedToUserId, updatedAt])
  @@index([status, updatedAt])
}

model Document {
  id            String       @id @default(cuid())
  kind          DocumentKind @default(CASE)

  caseId        String?
  taxCase       TaxCase?     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  profileUserId String?
  profileUser   User?        @relation("ProfileDocuments", fields: [profileUserId], references: [id], onDelete: Cascade)

  ownerId       String
  owner         User         @relation("OwnedDocuments", fields: [ownerId], references: [id], onDelete: Cascade)

  name          String
  mimeType      String
  size          Int
  storageKey    String
  uploadedAt    DateTime     @default(now())

  aadhaarForProfile ClientProfile? @relation("AadhaarDocument")

  @@index([caseId])
  @@index([profileUserId])
  @@index([ownerId])
  @@index([kind, uploadedAt])
}

model CaseAppointment {
  id            String            @id @default(cuid())
  caseId        String
  taxCase       TaxCase           @relation(fields: [caseId], references: [id], onDelete: Cascade)

  requestedAt   DateTime          @default(now())
  preferredDate String
  preferredTime String
  mode          AppointmentMode   @default(CALL)
  notes         String            @default("")
  status        AppointmentStatus @default(REQUESTED)
  scheduledFor  String?

  @@index([caseId, requestedAt])
  @@index([status, requestedAt])
}

model CaseInvoice {
  id          String        @id @default(cuid())
  caseId      String
  taxCase     TaxCase       @relation(fields: [caseId], references: [id], onDelete: Cascade)

  number      String
  dueDate     String
  currency    String        @default("INR")
  amount      Float
  description String
  status      InvoiceStatus @default(DRAFT)
  paymentLink String        @default("")

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([caseId, number])
  @@index([caseId, createdAt])
  @@index([status, createdAt])
}

model CaseTask {
  id         String     @id @default(cuid())
  caseId     String
  taxCase    TaxCase    @relation(fields: [caseId], references: [id], onDelete: Cascade)

  title      String
  status     TaskStatus @default(TODO)

  assigneeId String?
  assignee   User?      @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  createdAt  DateTime   @default(now())
  dueAt      DateTime?

  @@index([caseId, createdAt])
  @@index([assigneeId, status])
}

model CaseInternalNote {
  id          String   @id @default(cuid())
  caseId      String
  taxCase     TaxCase  @relation(fields: [caseId], references: [id], onDelete: Cascade)

  authorId    String?
  author      User?    @relation("AuthoredNotes", fields: [authorId], references: [id], onDelete: SetNull)

  authorEmail String
  authorName  String
  text        String
  createdAt   DateTime @default(now())

  @@index([caseId, createdAt])
  @@index([authorEmail, createdAt])
}
